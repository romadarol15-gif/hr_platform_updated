{% extends "base.html" %}
{% block content %}
<div class="container">
<div class="welcome-section">
<h2>Привет, {{ user.employee_profile.get_full_name|default:user.username }}!</h2>
<p>Добро пожаловать в систему управления персоналом</p>
</div>
{% if employee %}
<div class="dashboard-grid">
<div class="dashboard-card">
<h3>Трекер рабочего времени</h3>
{% if active_entry %}
<div class="tracker-active">
<p class="status-active">Трекер запущен</p>
<p class="time-info">Начало: <strong>{{ active_entry.start_time|date:"H:i, d.m.Y" }}</strong></p>
<p class="time-worked">Отработано: <strong id="time-counter">{{ active_entry.get_duration }}</strong></p>
<form method="post" action="{% url 'hr:time_stop' %}">
{% csrf_token %}
<button type="submit" class="btn btn-danger">Остановить</button>
</form>
</div>
<script>
// Обновляем счётчик времени каждую секунду
let startTime = new Date('{{ active_entry.start_time|date:"c" }}');
function updateTimer() {
    let now = new Date();
    let diff = now - startTime;
    let hours = Math.floor(diff / 3600000);
    let minutes = Math.floor((diff % 3600000) / 60000);
    let seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById('time-counter').textContent = hours + 'ч ' + minutes + 'мин ' + seconds + 'сек';
}
setInterval(updateTimer, 1000);
updateTimer();
</script>
{% else %}
<div class="tracker-inactive">
<p class="status-inactive">Трекер не активен</p>
<form method="post" action="{% url 'hr:time_start' %}">
{% csrf_token %}
<button type="submit" class="btn btn-primary">Запустить трекер</button>
</form>
</div>
{% endif %}
</div>
<div class="dashboard-card">
<h3>Новые задачи</h3>
{% if tasks %}
<ul class="task-list-mini">
{% for task in tasks %}
<li>
<span class="badge badge-{{ task.status }}">{{ task.get_status_display }}</span>
<strong>{{ task.get_task_id }}</strong> {{ task.title }}
{% if task.due_date %}<small>(до {{ task.due_date|date:"d.m.Y" }})</small>{% endif %}
</li>
{% endfor %}
</ul>
<a href="{% url 'hr:tasks' %}" class="btn btn-secondary btn-sm">Все задачи</a>
{% else %}
<p>Нет новых задач</p>
{% endif %}
</div>
</div>
{% endif %}
</div>
{% endblock %}