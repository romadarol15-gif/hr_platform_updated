{% extends "base.html" %}
{% block content %}
<div class="container">
<div class="profile-header">
<h2>
{% if viewing_own_profile %}Мой профиль{% else %}Профиль сотрудника{% endif %}
{% if not employee.user.is_active %}
<span class="badge badge-danger" style="margin-left: 1rem; background-color: #ef4444;">Профиль неактивен</span>
{% endif %}
</h2>
{% if not viewing_own_profile %}<p class="text-muted">Просмотр: {{ employee.get_full_name }}</p>{% endif %}
</div>
<div class="profile-section">
<div class="profile-avatar-section">
{% if employee.avatar %}
<img src="{{ employee.avatar.url }}" alt="Аватар" class="profile-avatar">
{% else %}
<div class="profile-avatar-placeholder">
<span>{{ employee.first_name.0|default:"?" }}{{ employee.last_name.0|default:"" }}</span>
</div>
{% endif %}
<div class="profile-info-short">
<h3>{{ employee.get_full_name }}</h3>
<p class="position">{{ employee.position }}</p>
<p class="department">{{ employee.department }}</p>
<p class="employee-number">Табельный №: <strong>{{ employee.user.username }}</strong></p>
{% if employee.email %}
<p class="employee-number">Email: <strong>{{ employee.email }}</strong></p>
{% endif %}
{% if employee.hire_date %}
<p class="employee-number">Дата приёма: <strong>{{ employee.hire_date|date:"d.m.Y" }}</strong></p>
{% endif %}
</div>
</div>

{% if can_fire %}
<div class="fire-restore-section" style="margin-bottom: 2rem; padding: 1rem; background-color: #fef3c7; border-radius: 0.5rem; border-left: 4px solid #f59e0b;">
<h4 style="margin-bottom: 1rem;">Действия с сотрудником</h4>
{% if employee.user.is_active %}
<form method="post" action="{% url 'hr:employee_fire' employee.id %}" style="display:inline;" onsubmit="return confirm('Вы уверены что хотите уволить этого сотрудника?\n\nПосле увольнения:\n- Профиль будет неактивен\n- Пароль изменится на Pass1234!!\n- Редактировать сможет только admin');">
{% csrf_token %}
<button type="submit" class="btn btn-danger">Уволить сотрудника</button>
</form>
<small class="form-text text-muted" style="margin-top: 0.5rem; display: block;">После увольнения профиль станет неактивным, пароль изменится. Восстановить сможет только admin.</small>
{% else %}
{% if user.is_superuser %}
<form method="post" action="{% url 'hr:employee_restore' employee.id %}" style="display:inline;" onsubmit="return confirm('Восстановить этого сотрудника?\n\nПароль будет сброшен на: Pass1234!');">
{% csrf_token %}
<button type="submit" class="btn btn-success">Восстановить сотрудника</button>
</form>
<small class="form-text text-muted" style="margin-top: 0.5rem; display: block;">Восстановление доступно только для администратора. Пароль будет: Pass1234!</small>
{% else %}
<p class="text-muted">Сотрудник уволен. Восстановить может только администратор.</p>
{% endif %}
{% endif %}
</div>
{% endif %}

<form method="post" class="profile-form" enctype="multipart/form-data">
{% csrf_token %}
<h3>Личная информация</h3>
<div class="form-grid">
<div class="form-group">
{{ form.last_name.label_tag }}
{{ form.last_name }}
</div>
<div class="form-group">
{{ form.first_name.label_tag }}
{{ form.first_name }}
</div>
<div class="form-group">
{{ form.middle_name.label_tag }}
{{ form.middle_name }}
</div>
</div>
<div class="form-grid">
<div class="form-group">
{{ form.email.label_tag }}
{{ form.email }}
</div>
<div class="form-group">
{{ form.phone.label_tag }}
{{ form.phone }}
</div>
<div class="form-group">
{{ form.avatar.label_tag }}
{{ form.avatar }}
{% if employee.avatar %}<p class="form-hint">Текущий: <a href="{{ employee.avatar.url }}" target="_blank">Посмотреть</a></p>{% endif %}
</div>
</div>
<h3>Должность и статус</h3>
<div class="form-grid">
<div class="form-group">
{{ form.role.label_tag }}
{{ form.role }}
</div>
<div class="form-group">
{{ form.position.label_tag }}
{{ form.position }}
</div>
<div class="form-group">
{{ form.department.label_tag }}
{{ form.department }}
</div>
<div class="form-group">
{{ form.status.label_tag }}
{{ form.status }}
</div>
</div>
{% if employee.hire_date %}
<div class="form-group">
{{ form.hire_date.label_tag }}
{{ form.hire_date }}
</div>
{% endif %}
<h3>Цели и опыт</h3>
<div class="form-group">
{{ form.annual_goal.label_tag }}
{{ form.annual_goal }}
</div>
<div class="form-group">
<label>Опыт внутри компании:</label>
<textarea class="form-control" rows="5" readonly style="background-color: #e9ecef;">{{ employee.get_work_experience }}</textarea>
<small class="form-text text-muted">Обновляется автоматически на основе истории должностей</small>
</div>
<div class="form-group">
{{ form.external_experience.label_tag }}
{{ form.external_experience }}
</div>
{% if can_edit %}
<button type="submit" class="btn btn-primary">Сохранить изменения</button>
{% endif %}
</form>
</div>

<div class="education-section">
<div class="section-header">
<h3>Образование</h3>
{% if viewing_own_profile or can_edit %}
<a href="{% url 'hr:education_add' %}{% if not viewing_own_profile %}?employee_id={{ employee.id }}{% endif %}" class="btn btn-primary btn-sm">Добавить образование</a>
{% endif %}
</div>
{% if educations %}
<div class="education-list">
{% for edu in educations %}
<div class="education-card">
<div class="education-header">
<h4>{{ edu.institution }}</h4>
<span class="badge badge-done">{{ edu.degree }}</span>
</div>
<p><strong>Специальность:</strong> {{ edu.field_of_study }}</p>
<p><strong>Период:</strong> {{ edu.start_year }} - {% if edu.end_year %}{{ edu.end_year }}{% else %}настоящее время{% endif %}</p>
{% if edu.description %}<p>{{ edu.description }}</p>{% endif %}
{% if edu.diploma_file %}
<p class="diploma-file"><a href="{{ edu.diploma_file.url }}" target="_blank">Диплом/Сертификат</a></p>
{% endif %}
{% if viewing_own_profile or can_edit %}
<div class="education-actions">
<a href="{% url 'hr:education_edit' edu.id %}" class="btn btn-secondary btn-sm">Редактировать</a>
<form method="post" action="{% url 'hr:education_delete' edu.id %}" style="display:inline;" onsubmit="return confirm('Удалить это образование?');">
{% csrf_token %}
<button type="submit" class="btn btn-danger btn-sm">Удалить</button>
</form>
</div>
{% endif %}
</div>
{% endfor %}
</div>
{% else %}
<p class="text-muted">Образование не добавлено</p>
{% endif %}
</div>

<div class="education-section">
<div class="section-header">
<h3>Документы</h3>
{% if viewing_own_profile or can_edit %}
<a href="{% url 'hr:document_add' %}{% if not viewing_own_profile %}?employee_id={{ employee.id }}{% endif %}" class="btn btn-primary btn-sm">Добавить документ</a>
{% endif %}
</div>
{% if documents %}
<div class="education-list">
{% for doc in documents %}
<div class="education-card">
<div class="education-header">
<h4>{{ doc.name }}</h4>
<span class="badge badge-done">{{ doc.get_file_size_mb }} МБ</span>
</div>
<p><strong>Дата загрузки:</strong> {{ doc.uploaded_at|date:"d.m.Y H:i" }}</p>
{% if doc.comment %}
<p><strong>Комментарий:</strong> {{ doc.comment }}</p>
{% endif %}
<p class="diploma-file"><a href="{{ doc.file.url }}" target="_blank" download>Скачать файл</a></p>
{% if viewing_own_profile or can_edit %}
<div class="education-actions">
<a href="{% url 'hr:document_edit' doc.id %}" class="btn btn-secondary btn-sm">Редактировать</a>
<form method="post" action="{% url 'hr:document_delete' doc.id %}" style="display:inline;" onsubmit="return confirm('Удалить этот документ?');">
{% csrf_token %}
<button type="submit" class="btn btn-danger btn-sm">Удалить</button>
</form>
</div>
{% endif %}
</div>
{% endfor %}
</div>
{% else %}
<p class="text-muted">Документы не добавлены</p>
{% endif %}
</div>

</div>
{% endblock %}