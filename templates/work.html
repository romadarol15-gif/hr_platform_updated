{% extends "base.html" %}
{% load calendar_filters %}
{% block content %}
<style>
.calendar-container {
    margin: 20px 0;
}
.calendar-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.calendar-table th {
    background: #6366f1;
    color: white;
    padding: 12px;
    text-align: center;
    font-weight: 600;
}
.calendar-table td {
    border: 1px solid #e5e7eb;
    padding: 8px;
    text-align: center;
    height: 80px;
    vertical-align: top;
    position: relative;
    cursor: pointer;
}
.calendar-table td:hover {
    background: #f9fafb;
}
.calendar-day {
    font-weight: 600;
    color: #374151;
}
.calendar-day.empty {
    color: #d1d5db;
}
.calendar-day.today {
    background: #6366f1;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.work-indicator {
    margin-top: 4px;
    font-size: 11px;
    color: #059669;
    font-weight: 600;
}
.tooltip-content {
    display: none;
    position: fixed;
    background: #1f2937;
    color: white;
    padding: 12px;
    border-radius: 6px;
    font-size: 12px;
    z-index: 10000;
    min-width: 200px;
    max-width: 300px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    pointer-events: none;
}
.calendar-table td:hover .tooltip-content {
    display: block;
}
.session-entry {
    margin-bottom: 8px;
    padding: 6px;
    background: #374151;
    border-radius: 4px;
}
.session-time {
    font-weight: 600;
    color: #10b981;
}
.session-duration {
    color: #9ca3af;
    font-size: 10px;
}
.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.calendar-nav h4 {
    margin: 0;
    color: #374151;
}
.calendar-nav .btn {
    padding: 6px 12px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}
.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 1000px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    position: relative;
    z-index: 10000;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e5e7eb;
}
.modal-header h3 {
    margin: 0;
    color: #374151;
}
.close {
    color: #9ca3af;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s;
    z-index: 10001;
}
.close:hover {
    color: #374151;
}
.search-box {
    margin-bottom: 20px;
    position: relative;
    z-index: 10002;
}
.search-box input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
}
.search-results {
    position: relative;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 20px;
    background: white;
    z-index: 10003;
}
.search-result-item {
    padding: 12px;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
    transition: background 0.2s;
}
.search-result-item:hover {
    background: #f9fafb;
}
.search-result-item:last-child {
    border-bottom: none;
}
.employee-time-section {
    display: none;
}
.employee-time-header {
    background: #f9fafb;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.time-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}
.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #6366f1;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.stat-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 5px;
}
.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #374151;
}
</style>

<div class="container">
<div class="page-header">
<h2>–†–∞–±–æ—Ç–∞</h2>
<div>
{% if can_view_employee_time %}
<button onclick="openEmployeeTimeModal()" class="btn btn-info" style="margin-right: 10px;">‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
{% endif %}
{% if can_create_employee %}
<a href="{% url 'hr:employee_create' %}" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</a>
{% endif %}
</div>
</div>

<!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ç—Ä–µ–∫–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
{% if calendar_data %}
<div class="work-section">
<div class="calendar-nav">
<a href="?year={{ calendar_data.prev_year }}&month={{ calendar_data.prev_month }}" class="btn btn-sm btn-outline-primary">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</a>
<h4>{{ calendar_data.month_name_rus }} {{ calendar_data.year }}</h4>
<a href="?year={{ calendar_data.next_year }}&month={{ calendar_data.next_month }}" class="btn btn-sm btn-outline-primary">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</a>
</div>

<div class="calendar-container">
<table class="calendar-table">
<thead>
<tr>
<th>–ü–Ω</th>
<th>–í—Ç</th>
<th>–°—Ä</th>
<th>–ß—Ç</th>
<th>–ü—Ç</th>
<th>–°–±</th>
<th>–í—Å</th>
</tr>
</thead>
<tbody>
{% for week in calendar_data.weeks %}
<tr>
{% for day in week %}
<td onmousemove="positionTooltip(event, this)">
{% if day != 0 %}
<div class="calendar-day {% if calendar_data.today.day == day and calendar_data.today.month == calendar_data.month and calendar_data.today.year == calendar_data.year %}today{% endif %}">
{{ day }}
</div>

{% if day in calendar_data.entries_by_date %}
{% with entries=calendar_data.entries_by_date|get_item:day %}
<div class="work-indicator">
‚úÖ {{ entries|length }} —Å–µ—Å—Å–∏{% if entries|length == 1 %}—è{% else %}–∏{% endif %}
</div>
<div class="tooltip-content">
<strong>{{ day }} {{ calendar_data.month_name_rus }}</strong><br>
{% for entry in entries %}
<div class="session-entry">
<div class="session-time">
üïí {{ entry.start_time|date:"H:i" }} - {% if entry.end_time %}{{ entry.end_time|date:"H:i" }}{% else %}–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...{% endif %}
</div>
{% if entry.end_time %}
<div class="session-duration">‚è±Ô∏è {{ entry.get_duration }}</div>
{% endif %}
</div>
{% endfor %}
</div>
{% endwith %}
{% endif %}
{% else %}
<div class="calendar-day empty"> </div>
{% endif %}
</td>
{% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
{% endif %}

<div class="work-section">
<div class="section-header">
<h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
<a href="{% url 'hr:work_request_create' %}" class="btn btn-primary btn-sm">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
</div>
{% if requests %}
<div class="requests-list">
{% for request in requests %}
<div class="request-card">
<div class="request-header">
<strong>{{ request.get_request_type_display }}</strong>
<span class="badge {% if request.approved %}badge-done{% else %}badge-new{% endif %}">
{% if request.approved %}‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ{% else %}‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏{% endif %}
</span>
</div>
<p>{{ request.description }}</p>
<small>{{ request.created_at|date:"d.m.Y H:i" }}</small>
{% if request.related_task %}
<p class="related-task"><small>–°–≤—è–∑–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞: {{ request.related_task.get_task_id }} - {{ request.related_task.title }} ({{ request.related_task.get_status_display }})</small></p>
{% endif %}
</div>
{% endfor %}
</div>
{% else %}
<p>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p>
{% endif %}
</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
<div id="employeeTimeModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>‚è±Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
<span class="close" onclick="closeEmployeeTimeModal()">&times;</span>
</div>

<div class="search-box">
<input type="text" id="employeeSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∏–ª–∏ —Ç–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä..." oninput="searchEmployees()">
</div>

<div id="searchResults" class="search-results" style="display: none;"></div>

<div id="employeeTimeSection" class="employee-time-section">
<div class="employee-time-header">
<h4 id="selectedEmployeeName"></h4>
<div class="time-stats" id="timeStats"></div>
</div>

<div class="calendar-nav">
<button onclick="changeModalMonth(-1)" class="btn btn-sm btn-outline-primary">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
<h4 id="modalMonthYear"></h4>
<button onclick="changeModalMonth(1)" class="btn btn-sm btn-outline-primary">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
</div>

<div class="calendar-container">
<table class="calendar-table" id="modalCalendar">
<thead>
<tr>
<th>–ü–Ω</th>
<th>–í—Ç</th>
<th>–°—Ä</th>
<th>–ß—Ç</th>
<th>–ü—Ç</th>
<th>–°–±</th>
<th>–í—Å</th>
</tr>
</thead>
<tbody id="modalCalendarBody"></tbody>
</table>
</div>
</div>
</div>
</div>

<script>
function positionTooltip(event, cell) {
    const tooltip = cell.querySelector('.tooltip-content');
    if (tooltip && window.getComputedStyle(tooltip).display === 'block') {
        const rect = cell.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        
        let left = event.clientX + 10;
        let top = event.clientY + 10;
        
        if (left + tooltipRect.width > window.innerWidth) {
            left = event.clientX - tooltipRect.width - 10;
        }
        
        if (top + tooltipRect.height > window.innerHeight) {
            top = event.clientY - tooltipRect.height - 10;
        }
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
    }
}

let selectedEmployeeId = null;
let modalYear = {{ calendar_data.year|default:2026 }};
let modalMonth = {{ calendar_data.month|default:2 }};
let searchTimeout = null;

function openEmployeeTimeModal() {
    document.getElementById('employeeTimeModal').style.display = 'block';
}

function closeEmployeeTimeModal() {
    document.getElementById('employeeTimeModal').style.display = 'none';
    document.getElementById('employeeSearch').value = '';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('employeeTimeSection').style.display = 'none';
    selectedEmployeeId = null;
}

function searchEmployees() {
    const query = document.getElementById('employeeSearch').value.trim();
    
    if (searchTimeout) clearTimeout(searchTimeout);
    
    if (query.length < 2) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch(`{% url 'hr:employee_search' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('searchResults');
                if (data.results.length > 0) {
                    resultsDiv.innerHTML = data.results.map(emp => `
                        <div class="search-result-item" onclick="selectEmployee(${emp.id}, '${emp.full_name}', '${emp.username}')">
                            <strong>${emp.full_name}</strong><br>
                            <small>–¢–∞–±–µ–ª—å–Ω—ã–π: ${emp.username} | ${emp.position}</small>
                        </div>
                    `).join('');
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div class="search-result-item">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    resultsDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '<div class="search-result-item">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
                resultsDiv.style.display = 'block';
            });
    }, 300);
}

function selectEmployee(employeeId, fullName, username) {
    selectedEmployeeId = employeeId;
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('employeeSearch').value = fullName;
    document.getElementById('selectedEmployeeName').textContent = `${fullName} (${username})`;
    
    const today = new Date();
    modalYear = today.getFullYear();
    modalMonth = today.getMonth() + 1;
    
    loadEmployeeCalendar();
}

function changeModalMonth(delta) {
    modalMonth += delta;
    if (modalMonth < 1) {
        modalMonth = 12;
        modalYear--;
    } else if (modalMonth > 12) {
        modalMonth = 1;
        modalYear++;
    }
    loadEmployeeCalendar();
}

function loadEmployeeCalendar() {
    if (!selectedEmployeeId) return;
    
    fetch(`{% url 'hr:employee_time_api' 0 %}`.replace('0', selectedEmployeeId) + `?year=${modalYear}&month=${modalMonth}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('employeeTimeSection').style.display = 'block';
            document.getElementById('modalMonthYear').textContent = `${data.month_name_rus} ${data.year}`;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π</div>
                    <div class="stat-value">${data.total_sessions}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–∏</div>
                    <div class="stat-value">${data.total_hours}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</div>
                    <div class="stat-value">${data.working_days}</div>
                </div>
            `;
            document.getElementById('timeStats').innerHTML = statsHTML;
            
            // –ö–∞–ª–µ–Ω–¥–∞—Ä—å
            const tbody = document.getElementById('modalCalendarBody');
            tbody.innerHTML = data.weeks.map(week => `
                <tr>
                    ${week.map(day => {
                        if (day === 0) {
                            return '<td><div class="calendar-day empty"> </div></td>';
                        }
                        
                        const entries = data.entries_by_date[day] || [];
                        const isToday = data.today.day === day && data.today.month === data.month && data.today.year === data.year;
                        
                        return `
                            <td>
                                <div class="calendar-day ${isToday ? 'today' : ''}">${day}</div>
                                ${entries.length > 0 ? `
                                    <div class="work-indicator">
                                        ‚úÖ ${entries.length} —Å–µ—Å—Å–∏${entries.length === 1 ? '—è' : '–∏'}
                                    </div>
                                    <div class="tooltip-content" style="display: none;">
                                        <strong>${day} ${data.month_name_rus}</strong><br>
                                        ${entries.map(e => `
                                            <div class="session-entry">
                                                <div class="session-time">
                                                    üïí ${e.start} - ${e.end || '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...'}
                                                </div>
                                                ${e.duration ? `<div class="session-duration">‚è±Ô∏è ${e.duration}</div>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </td>
                        `;
                    }).join('')}
                </tr>
            `).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è tooltip
            tbody.querySelectorAll('td').forEach(cell => {
                cell.addEventListener('mousemove', (e) => positionTooltip(e, cell));
                cell.addEventListener('mouseenter', (e) => {
                    const tooltip = cell.querySelector('.tooltip-content');
                    if (tooltip) tooltip.style.display = 'block';
                });
                cell.addEventListener('mouseleave', () => {
                    const tooltip = cell.querySelector('.tooltip-content');
                    if (tooltip) tooltip.style.display = 'none';
                });
            });
        })
        .catch(error => {
            console.error('Calendar load error:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
        });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
window.onclick = function(event) {
    const modal = document.getElementById('employeeTimeModal');
    if (event.target === modal) {
        closeEmployeeTimeModal();
    }
}
</script>
{% endblock %}